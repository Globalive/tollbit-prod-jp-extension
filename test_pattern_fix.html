<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Pattern Translation Fix Test</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .test-case { margin: 15px 0; padding: 10px; border: 1px solid #ccc; }
    .pass { background: #d4edda; }
    .fail { background: #f8d7da; }
  </style>
</head>
<body>
  <h1>Pattern Translation Fix Test</h1>
  <div id="results"></div>

  <script>
    // テストケース
    const testCases = [
      { input: "Updated 55 days ago", expected: "55日前に更新" },
      { input: "Members (5)", expected: "メンバー (5)" },
      { input: "down 30.2%", expected: "30.2％減少" },
      { input: "up 15.7%", expected: "15.7％増加" },
      { input: "$100.50", expected: "$100.50" }, // Dollar sign pattern
      { input: "99th percentile", expected: /\d+th/, pattern: true }, // 数字が含まれるべき
    ];

    // パターン定義（修正前のコード）
    const PATTERN_TRANSLATIONS_OLD = [
      { pattern: "Updated (\\d+) days? ago", replacement: "$1日前に更新" },
      { pattern: "Members \\((\\d+)\\)", replacement: "メンバー ($1)" },
      { pattern: "down ([\\d.]+)%", replacement: "$1％減少" },
      { pattern: "up ([\\d.]+)%", replacement: "$1％増加" },
      { pattern: "\\$([\\d.]+)", replacement: "$$$1" },
    ];

    function normalizeText(text) {
      return text.replace(/[.,!?;:\s]+$/, '');
    }

    // 修正前の翻訳ロジック（バグあり）
    function translateOld(text) {
      const trimmed = text.trim();
      const normalized = normalizeText(trimmed);

      for (const patternObj of PATTERN_TRANSLATIONS_OLD) {
        try {
          const regex = new RegExp(patternObj.pattern, 'i');
          if (regex.test(normalized)) {
            // ❌ BUG: normalizedに対してreplaceしている
            const japanese = normalized.replace(regex, patternObj.replacement);
            return japanese;
          }
        } catch (e) {
          console.error('Error:', e);
        }
      }
      return null;
    }

    // 修正後の翻訳ロジック
    function translateNew(text) {
      const trimmed = text.trim();
      const normalized = normalizeText(trimmed);

      for (const patternObj of PATTERN_TRANSLATIONS_OLD) {
        try {
          const regex = new RegExp(patternObj.pattern, 'i');
          if (regex.test(normalized)) {
            // ✅ FIX: trimmedに対してreplaceする
            const japanese = trimmed.replace(regex, patternObj.replacement);
            return japanese;
          }
        } catch (e) {
          console.error('Error:', e);
        }
      }
      return null;
    }

    // テスト実行
    const resultsDiv = document.getElementById('results');
    let passCount = 0;
    let failCount = 0;

    testCases.forEach((testCase, index) => {
      const resultOld = translateOld(testCase.input);
      const resultNew = translateNew(testCase.input);

      const div = document.createElement('div');
      div.className = 'test-case';

      let oldPass, newPass;

      if (testCase.pattern) {
        // Regex test
        oldPass = testCase.expected.test(resultOld || '');
        newPass = testCase.expected.test(resultNew || '');
      } else {
        oldPass = resultOld === testCase.expected;
        newPass = resultNew === testCase.expected;
      }

      if (newPass) {
        passCount++;
        div.classList.add('pass');
      } else {
        failCount++;
        div.classList.add('fail');
      }

      div.innerHTML = `
        <strong>Test #${index + 1}: ${newPass ? '✅ PASS' : '❌ FAIL'}</strong><br>
        Input: "${testCase.input}"<br>
        Expected: ${testCase.pattern ? `Pattern: ${testCase.expected}` : `"${testCase.expected}"`}<br>
        Old Result: "${resultOld}" ${oldPass ? '✅' : '❌'}<br>
        New Result: "${resultNew}" ${newPass ? '✅' : '❌'}
      `;

      resultsDiv.appendChild(div);
    });

    // Summary
    const summary = document.createElement('div');
    summary.style.marginTop = '20px';
    summary.style.padding = '10px';
    summary.style.background = failCount === 0 ? '#d4edda' : '#f8d7da';
    summary.innerHTML = `
      <h2>Summary</h2>
      Total: ${testCases.length}<br>
      Pass: ${passCount}<br>
      Fail: ${failCount}
    `;
    resultsDiv.appendChild(summary);
  </script>
</body>
</html>
