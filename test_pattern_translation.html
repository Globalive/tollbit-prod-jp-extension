<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>パターン翻訳テスト - TollBit拡張機能</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
    .test-section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .test-case { margin: 10px 0; padding: 10px; border-left: 4px solid #ddd; }
    .test-case.pass { border-color: #4CAF50; background: #f1f8f4; }
    .test-case.fail { border-color: #f44336; background: #fef5f5; }
    .input { color: #1976D2; font-weight: bold; }
    .expected { color: #388E3C; }
    .actual { color: #D32F2F; }
    h1 { color: #333; }
    h2 { color: #666; margin-top: 0; }
    .summary { font-size: 18px; font-weight: bold; padding: 15px; margin: 20px 0; border-radius: 8px; }
    .summary.pass { background: #4CAF50; color: white; }
    .summary.fail { background: #f44336; color: white; }
  </style>
</head>
<body>
  <h1>🧪 TollBit 拡張機能 - パターン翻訳テスト</h1>
  <div id="results"></div>

  <script>
    // パターン翻訳定義（content-cross-frame.jsから抽出）
    const PATTERN_TRANSLATIONS = [
      {
        "pattern": "Updated (\\d+) days? ago",
        "replacement": "$1日前に更新"
      },
      {
        "pattern": "Members \\((\\d+)\\)",
        "replacement": "メンバー ($1)"
      },
      {
        "pattern": "AI bots made ([\\d.]+[KMB]) requests to your website, down ([\\d.]+)% from the previous week",
        "replacement": "AIボットがあなたのウェブサイトに$1万件のリクエストを行いました。前週比で$2%減少しています。"
      },
      {
        "pattern": "You receive more traffic from AI bots than ([\\d.]+)% of other publishers",
        "replacement": "あなたは他のサイトの$1%より多く、AIボットからのトラフィックがあります。"
      },
      {
        "pattern": "Top (\\d+) Bots?",
        "replacement": "上位$1ボット"
      },
      {
        "pattern": "Breakdown the top (\\d+) most active bot agents accessing your content",
        "replacement": "あなたのコンテンツにアクセスしている最も活発なボットエージェント上位$1の内訳"
      },
      {
        "pattern": "\\$([\\d.]+)",
        "replacement": "$$$1"
      },
      {
        "pattern": "down ([\\d.]+)%",
        "replacement": "$1％減少"
      },
      {
        "pattern": "up ([\\d.]+)%",
        "replacement": "$1％増加"
      },
      {
        "pattern": "You receive more traffic from this bot than ([\\d.]+)% of other publishers.",
        "replacement": "あなたはこのボットから他の$1%のサイトより多くのトラフィックを受け取っています。"
      },
      {
        "pattern": "only (\\d+)% of websites were scraped more",
        "replacement": "$1％に位置しています。"
      },
      {
        "pattern": "no websites were scraped more",
        "replacement": "どのサイトよりも多く、このAIボットにクロールされています。"
      },
      {
        "pattern": "You receive more traffic from this bot than ([\\d.]+)% of other publishers.",
        "replacement": "あなたのサイトは、このボットから他のサイトの$1％よりも多くのボットトラフィックを受け取っています。"
      },
      {
        "pattern": "(\\d+) days? ago",
        "replacement": "$1日前"
      }
    ];

    // テキストを正規化（末尾の句読点とスペースを除去）
    function normalizeText(text) {
      return text.replace(/[.,!?;:\s]+$/, '');
    }

    // パターン翻訳を実行
    function translatePattern(text) {
      const normalized = normalizeText(text);

      for (const patternObj of PATTERN_TRANSLATIONS) {
        try {
          const regex = new RegExp(patternObj.pattern, 'i');
          if (regex.test(normalized)) {
            return normalized.replace(regex, patternObj.replacement);
          }
        } catch (e) {
          console.error(`[パターンエラー] ${patternObj.pattern}:`, e);
          return null;
        }
      }

      return null; // マッチしなかった
    }

    // テストケース定義
    const testCases = [
      {
        name: "パーセンテージ減少 (down)",
        input: "down 30.2%",
        expected: "30.2％減少"
      },
      {
        name: "パーセンテージ増加 (up)",
        input: "up 15.7%",
        expected: "15.7％増加"
      },
      {
        name: "日数（単数）",
        input: "Updated 1 day ago",
        expected: "1日前に更新"
      },
      {
        name: "日数（複数）",
        input: "Updated 55 days ago",
        expected: "55日前に更新"
      },
      {
        name: "日数のみ（単数）",
        input: "1 day ago",
        expected: "1日前"
      },
      {
        name: "日数のみ（複数）",
        input: "30 days ago",
        expected: "30日前"
      },
      {
        name: "メンバー数",
        input: "Members (5)",
        expected: "メンバー (5)"
      },
      {
        name: "金額",
        input: "$123.45",
        expected: "$123.45"
      },
      {
        name: "Top Bots（単数）",
        input: "Top 1 Bot",
        expected: "上位1ボット"
      },
      {
        name: "Top Bots（複数）",
        input: "Top 5 Bots",
        expected: "上位5ボット"
      },
      {
        name: "パーセンタイル",
        input: "You receive more traffic from AI bots than 95.5% of other publishers",
        expected: "あなたは他のサイトの95.5%より多く、AIボットからのトラフィックがあります。"
      },
      {
        name: "複雑なパターン（AI bots made）",
        input: "AI bots made 1.2K requests to your website, down 30.2% from the previous week",
        expected: "AIボットがあなたのウェブサイトに1.2K万件のリクエストを行いました。前週比で30.2%減少しています。"
      }
    ];

    // テスト実行
    function runTests() {
      const results = [];
      let passCount = 0;
      let failCount = 0;

      testCases.forEach((testCase, index) => {
        const actual = translatePattern(testCase.input);
        const pass = actual === testCase.expected;

        if (pass) {
          passCount++;
        } else {
          failCount++;
        }

        results.push({
          ...testCase,
          actual,
          pass,
          index: index + 1
        });
      });

      return { results, passCount, failCount, total: testCases.length };
    }

    // 結果を表示
    function displayResults() {
      const { results, passCount, failCount, total } = runTests();
      const resultsDiv = document.getElementById('results');

      // サマリー
      const summaryClass = failCount === 0 ? 'pass' : 'fail';
      const summaryText = failCount === 0
        ? `✅ 全テスト成功！ (${passCount}/${total})`
        : `❌ ${failCount}個のテストが失敗 (成功: ${passCount}/${total})`;

      let html = `<div class="summary ${summaryClass}">${summaryText}</div>`;

      // 各テストケース
      results.forEach(result => {
        const statusIcon = result.pass ? '✅' : '❌';
        const statusClass = result.pass ? 'pass' : 'fail';

        html += `
          <div class="test-section">
            <div class="test-case ${statusClass}">
              <h2>${statusIcon} テスト #${result.index}: ${result.name}</h2>
              <div><strong>入力:</strong> <span class="input">"${result.input}"</span></div>
              <div><strong>期待値:</strong> <span class="expected">"${result.expected}"</span></div>
              <div><strong>実際:</strong> <span class="${result.pass ? 'expected' : 'actual'}">"${result.actual}"</span></div>
              ${!result.pass ? '<div style="color: #D32F2F; font-weight: bold; margin-top: 10px;">⚠️ マッチしませんでした</div>' : ''}
            </div>
          </div>
        `;
      });

      resultsDiv.innerHTML = html;
    }

    // ページ読み込み時に実行
    displayResults();
  </script>
</body>
</html>
